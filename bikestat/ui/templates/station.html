{% extends "base.html" %}
{% load url from future %}

{% block javascript_extra %}
<script src="http://d3js.org/d3.v2.min.js"></script>
{% endblock javascript_extra %}

{% block stylesheet_extra %}
<style type='text/css'>
    rect {
        font: 10px sans-serif;
        text-align: right;
        padding: 4px;
        margin: 1px;
        color: white;
    }
</style>
{% endblock stylesheet_extra %}


{% block content %}
<h1>{{ station.desc }}</h1>

<div id='viz'>
    <p>
{{ count }} docking events since {{ first.date }}
    </p>
</div>

<script type='text/javascript'>
    d3.json('{% url "station_monthly_summary_json" station.id %}',
            update);
    var width = 1000;
    var height = 200;
    var svg = d3.select('#viz')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    function update(data) {
        var x = d3.scale.linear()
            .domain([0, 200 + d3.max(data.map(function(d) { return d.total; }))])
            .range([0, width]);

        svg.selectAll('rect')
            .data(data)
          .enter().append('rect')
            .attr('x', 0)
            .attr('y', function(d, i) { return i * 20; })
            .attr('width', function(d) { return x(d.total); })
            .attr('height', 19)
            .attr('fill', 'khaki');

        svg.selectAll('rect.div')
            .data(data)
          .enter().append('rect')
            .attr('x', function(d) { return x(d.start); })
            .attr('y', function(d, i) { return i * 20; })
            .attr('width', 1)
            .attr('height', 19)
            .attr('fill', 'darkslateblue');

        svg.selectAll('text')
            .data(data)
          .enter().append('text')
            .text(function(d) { return d.month; })
            .attr('x', 5)
            .attr('y', function(d, i) { return 14 + (i * 20); })
            .attr('fill', 'darkslateblue')

        svg.selectAll('text.start')
            .data(data)
          .enter().append('text')
            .text(function(d) { return d.start; })
            .attr('x', function(d) { return x(d.start); })
            .attr('y', function(d, i) { return 14 + (i * 20); })
            .attr('dx', '-2.5em')
            .attr('fill', 'darkolivegreen');

        svg.selectAll('text.end')
            .data(data)
          .enter().append('text')
            .text(function(d) { return d.end; })
            .attr('x', function(d) { return x(d.start); })
            .attr('y', function(d, i) { return 14 + (i * 20); })
            .attr('dx', '1em')
            .attr('fill', 'maroon');

        svg.selectAll('text.total')
            .data(data)
          .enter().append('text')
            .text(function(d) { return d.total; })
            .attr('x', function(d) { return x(d.total); })
            .attr('y', function(d, i) { return 14 + (i * 20); })
            .attr('dx', '10px')
            .attr('fill', 'black');
    };
</script>

<div class='pagination'>
    <span class='step-links'>
        {% if events.has_previous %}
        <a href='{% url 'station' station.id %}?page=1'>&laquo;</a>
        <a href='{% url 'station' station.id %}?page={{ events.previous_page_number }}'>next</a>
        {% endif %}
        <span class='current'>
            {{ events.number }} of {{ events.paginator.num_pages }}
        </span>
        {% if events.has_next %}
        <a href='{% url 'station' station.id %}?page={{ events.next_page_number }}'>prior</a>
        <a href='{% url 'station' station.id %}?page={{ events.paginator.num_pages }}'>&raquo;</a>
        {% endif %}
    </span>
</div>

<table class='table'>
    <thead>
        <th width='12%'>type</th>
        <th width='10%'>time</th>
        <th width='8%'>bike</th>
        <th>other station</th>
    </thead>
    <tbody>
        {% regroup events by date.date as date_groups %}
        {% for date_group in date_groups %}
        <tr>
            <td colspan='4'>
                <h4>{{ date_group.grouper|date:"Y-m-d - l" }}</h4>
            </td>
        </tr>
            {% for event in date_group.list|dictsortreversed:"date.time" %}
        <tr>
            {% if event.is_end %}
            <td>
                &nbsp;
            {% else %}
            <td class='start-row'>
                start &raquo; {{ event.ride.duration_minutes }} min
            {% endif %}
            </td>
            <td>
                {{ event.date|date:"P" }}
            </td>
            <td>
                <a href='{% url "bike" event.bike.id %}'>{{ event.bike.num }}</a>
            </td>
            <td>
                {% if event.is_end %}
                from
                <a href='{% url "station" event.ride.station_start.id %}'>{{ event.ride.station_start.desc }}</a>
                {% else %}
                to
                <a href='{% url "station" event.ride.station_end.id %}'>{{ event.ride.station_end.desc }}</a>
                {% endif %}
            </td>
        </tr>
            {% endfor %}
        {% endfor %}
    </tbody>
</table>
{% endblock content %}
